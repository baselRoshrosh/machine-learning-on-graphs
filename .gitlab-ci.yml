stages:
  - build
  - test

variables:
  BUILD_DIR: build

# Trigger pipeline for merge requests
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build stage
build:
  stage: build
  image: ubuntu:22.04 # Use a base image
  before_script:
    - apt-get update && apt-get install -y cmake make g++
    - git submodule update --init --recursive # Fetch submodules
  script:
    - echo "Starting build process..."
    - mkdir -p $BUILD_DIR
    - cd $BUILD_DIR
    - cmake ..
    - cmake --build .
  artifacts:
    paths:
      - $BUILD_DIR # Save the build artifacts for later stages

# Test stage
test:
  stage: test
  script:
    - echo "Running tests..."
    - cd $BUILD_DIR
    - ctest --output-on-failure # Execute tests with detailed output
  dependencies:
    - build # Ensure the build stage is completed before running tests
