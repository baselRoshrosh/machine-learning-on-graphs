image: debian:latest  # Use Debian which includes Git by default

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - deploy

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  variables:
    GIT_DEPTH: 0
  before_script:
    - apt-get update && apt-get install -y git cmake g++ python3 python3-pip
  script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - git --version  # Check if Git is installed
    - python3 --version  # Check if Python3 is installed
    - git submodule update --init --recursive  # Ensure submodules are initialized
    - mkdir -p build && cd build
    - cmake .. -DBUILD_TESTS=ON -DPYTHON_EXECUTABLE=/usr/bin/python3  # Python3 and TEST=ON
    - make  # Compiles the project
  artifacts:
    paths:
      - build
  only:
    - main
    - merge_requests #Runs only on merge requests

unit-test-job:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  before_script:
    - apt-get update && apt-get install -y cmake g++
  script:
    - cd build
    - ctest --output-on-failure  # Run tests
  dependencies:
    - build-job  # This job depends on the build job
  only:
    - merge_requests #Runs only on merge requests

lint-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  script:
    - echo "Linting code... (placeholder)"
    - sleep 1
    - echo "No lint issues found."

deploy-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  script:
    - echo "Saving compiled binary..."
    - ls -la build/  # List all files to see what was compiled
    - mkdir -p artifacts
    - cp -r build/* artifacts/  # Copy all built files to artifacts
  artifacts:
    paths:
      - artifacts/
  dependencies:
    - build-job  # Ensure it gets build artifacts
  only:
    - main
    - merge_requests